@model SalesAndInventory.ViewModels.ProductListViewModel

@{
    ViewBag.Title = "Product";
    ViewBag.Link = "product";
    int listCounter = 0;
}

<h2>
    Inventory
</h2>

<div class="row">
    <div class="col-md-12 animatedParent animateOnce z-index-49">
        <div class="tabs-container animated fadeInUp go">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a aria-expanded="true" href="#tab-1" data-toggle="tab">
                        <i class="icon-check"></i> Available Stocks
                        @if (Model.Stocks.Count >= 1)
                        {<span class="badge badge-success" id="badge-stocks">@Model.Stocks.Count</span>}
                    </a>
                </li>
                <li>
                    <a aria-expanded="false" href="#tab-2" data-toggle="tab">
                        <i class="icon-cancel"></i> Out of Stocks
                        @if (Model.OutOfStocks.Count >= 1)
                        {<span class="badge badge-danger" id="badge-outofstocks">@Model.OutOfStocks.Count</span>}
                    </a>
                </li>
                <li>
                    <a aria-expanded="false" href="#tab-3" data-toggle="tab">
                        <i class="icon-attention"></i> Unassigned
                        @if (Model.UnassignedStoks.Count >= 1)
                        {<span class="badge badge-warning" id="badge-unassignedstocks">@Model.UnassignedStoks.Count</span>}
                    </a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="tab-1">
                    <div class="panel-body">
                        @*Stocks*@
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover dt">
                                <thead>
                                    <tr>
                                        <th>Carton No.</th>
                                        <th>Brand</th>
                                        <th>Product Name</th>
                                        <th>Model</th>
                                        <th>Carton Barcode</th>
                                        <th>Pcks/Carton</th>
                                        <th>Pcs/Pack</th>
                                        <th>Total Stocks</th>
                                        <th>Selling Price/Item</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-stocks">
                                    @{ listCounter = 0; }
                                    @foreach (var stock in Model.Stocks)
                                    {
                                        listCounter++; ViewBag.Counter = listCounter;
                                        <tr>
                                            <td>@ViewBag.Counter</td>
                                            <td>@stock.Brand</td>
                                            <td>@stock.Name</td>
                                            <td>@stock.Model</td>
                                            <td>@stock.CartonBarcode</td>
                                            <td>@stock.QtyByPck</td>
                                            <td>@stock.QtyByPc</td>
                                            <td>@stock.TotalItemStocks</td>
                                            <td>
                                                <a href="#" class="strong-7" data-toggle="modal" data-target="#modal-sellingprice" onclick="LoadPriceList();">
                                                    @stock.SellingPrice
                                                </a>
                                            </td>
                                        </tr>
                                    }

                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th>@Model.TotalSellingPrice</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tab-2">
                    <div class="panel-body">
                        <div class="table-responsive" style="overflow-x: hidden">
                            <table class="table table-striped table-bordered table-hover dt">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Brand</th>
                                        <th>Product Name</th>
                                        <th>Model</th>
                                        <th>Barcode</th>
                                        <th>Stocks</th>
                                        <th>Selling Price</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-outofstock">
                                    @{ listCounter = 0; }
                                    @foreach (var outOfStocks in Model.OutOfStocks)
                                    {
                                        listCounter++; ViewBag.Counter = listCounter;
                                        <tr>
                                            <td>@ViewBag.Counter</td>
                                            <td>@outOfStocks.Brand</td>
                                            <td>@outOfStocks.Name</td>
                                            <td>@outOfStocks.Model</td>
                                            <td>@outOfStocks.ItemBarcode</td>
                                            <td>@outOfStocks.QtyByPc</td>
                                            <td>@outOfStocks.SellingPrice</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th>No.</th>
                                        <th>Brand</th>
                                        <th>Product Name</th>
                                        <th>Model</th>
                                        <th>Barcode</th>
                                        <th>Stocks</th>
                                        <th>Selling Price</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tab-3">
                    <div class="panel-body">
                        <div class="table-responsive" style="overflow-x: hidden">
                            <table class="table table-striped table-bordered table-hover dt">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Brand</th>
                                        <th>Product Name</th>
                                        <th>Model</th>
                                        <th>Stocks Available</th>
                                        <th>Unit Price</th>
                                        <th>SRP</th>
                                        <th>Selling Price</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-unassigned">
                                    @{ listCounter = 0; }
                                    @foreach (var unassignedStocks in Model.UnassignedStoks)
                                    {
                                        listCounter++; ViewBag.Counter = listCounter;
                                        <tr>
                                            <td>@ViewBag.Counter</td>
                                            <td>@unassignedStocks.Brand</td>
                                            <td>@unassignedStocks.Name</td>
                                            <td>@unassignedStocks.Model</td>
                                            <td>@unassignedStocks.TotalItemStocks</td>
                                            <td>@unassignedStocks.UnitPrice</td>
                                            <td>@unassignedStocks.Srp</td>
                                            <td>@unassignedStocks.SellingPrice</td>
                                            <td>
                                                <button class="btn btn-info btn-sm btn-setprice" data-toggle="modal" data-target="#modal-assign-values" data-sid="@unassignedStocks.Id">Set Price</button>
                                            </td>
                                        </tr>
                                    }

                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th></th>
                                        <th>Brand</th>
                                        <th>Product Name</th>
                                        <th>Model</th>
                                        <th>Orginal Price</th>
                                        <th>SRP</th>
                                        <th>Selling Price</th>
                                        <th>VAT</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@* --  MODALS STARTS HERE  -- *@
@*Assigned Values*@
<div id="modal-assign-values" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">Assign Price</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Selling Price</label>
                    <input class="form-control" type="number" id="txt-sellingprice" step="0.01" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btn-save-assignedvalues" data-modsid="">Save</button>
            </div>
        </div>
    </div>
</div>
@*Stock-in*@
<div id="modal-stockin" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">Stock-In</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hid-prodid" data-pid="" />

                <div class="form-group">
                    <label>Quantity</label>
                    <input class="form-control" type="number" id="txt-qty" step="0.01" />
                </div>
                <div class="form-group">
                    <label>Barcode</label>
                    <input class="form-control" type="text" id="txt-barcode" />
                </div>
                <h5></h5>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btn-stockin" data-pid="">Add</button>
            </div>
        </div>
    </div>
</div>

@*Selling Price*@
<div id="modal-sellingprice" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">Price List</h4>
            </div>
            <div class="modal-body padding-0">

                <table class="table table-users table-bordered table-hover margin-b-0" id="tbl-pricelist">
                    <tbody>
                        <tr>
                            <td class="size-60 text-center"><div class="form-checkbox"><input type="checkbox" value="value1" name="name1"> <span class="check"><i class="fa fa-check"></i></span></div></td>
                            <td class="size-80"><img title="" alt="" src="images/john-smith.png" class="avatar img-circle"></td>
                            <td><strong>John Smith</strong></td>
                            <td>Member since 2008</td>
                            <td>Last login yesterday.</td>
                            <td class="text-center"><span class="badge badge-bordered">Admin</span></td>
                            <td class="text-center"><i class="icon-check icon-larger green-color"></i></td>
                            <td class="size-80 text-center">
                                <div class="dropdown">
                                    <a class="more-link" data-toggle="dropdown" href="#/"><i class="icon-dot-3 ellipsis-icon"></i></a>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                        <li><a href="">Change Date Range</a></li>
                                        <li><a href="">Change Graph Type</a></li>
                                        <li><a href="">Other Settings</a> </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <link href="/Content/css/plugins/datatables/jquery.dataTables.css" rel="stylesheet">
    <link href="/Scripts/js/plugins/datatables/extensions/Buttons/css/buttons.dataTables.css" rel="stylesheet">
    @Scripts.Render("~/bundles/dataTables")

    <script>
        $(document).ready(function () {
            $('.dt').DataTable();
        });

        $('button').on('click', function () {
            var getId = $(this).data('sid')
            if ($(this).hasClass("btn-setprice")) {
                $('#btn-save-assignedvalues').data('modsid', getId);
            }
            else if ($(this).html() == "Stock-In") {
                $('#btn-stockin').data('pid', $(this).data('prodid'));
                $('#hid-prodid').data('pid', $(this).data('prodid'));
            }
        });

        // Save assigned values (BUTTON ON-CLICK)
        $('#btn-save-assignedvalues').on('click', function () {
            var sellingPrice = $('#txt-sellingprice').val();
            var prodid = $(this).data('modsid');

            $.getJSON("/Product/UpdateProductValues", { sellingPrice: sellingPrice, productId: prodid })
                .done(function (data) {
                    if (data == true) {
                        $(".modal").modal('hide');
                        $.notify("Price updated successfully", "success");

                        ReloadAvailableStocks();
                        ReloadOutOfStocks();
                        ReloadUnassigned();
                    }
                })
                .fail(function () {
                    console.log("Error updating values");
                });
        });



        // Refresh AVAILABLE STOCKS list
        function ReloadAvailableStocks() {
            $('#tbody-stocks').html('<img src="/Icon/loading-spinner-34.gif" class="center-block" />');
            $.getJSON("/Product/GetAvailableStocks")
                .done(function (data) {
                    $('#tbody-stocks').html('');
                    $.each(data, function (i, v) {
                        $('#tbody-stocks').append('<tr>\
                                                <td>'+ i + '</td>\
                                                <td>'+ v.Brand + '</td>\
                                                <td>'+ v.Name + '</td>\
                                                <td>'+ v.Model + '</td>\
                                                <td>'+ v.CartonBarcode + '</td>\
                                                <td>'+ v.QtyByPck + '</td>\
                                                <td>'+ v.QtyByPc + '</td>\
                                                <td>'+ v.TotalItemStocks + '</td>\
                                                <td>\
                                                    <a href="#" class="strong-7">\
                                                        '+ v.SellingPrice + '\
                                                    </a>\
                                                </td>\
                                            </tr>');
                    });

                    $('#badge-stocks').html(data.length);
                })
                .fail(function () {
                    console.log("Error retrieving available stocks");
                });
        }
        // Refresh OUT OF STOCKS list
        function ReloadOutOfStocks() {
            $.getJSON("/Product/GetOutOfStocks")
                .done(function (data) {
                    $('#tbody-outofstock').html('');
                    $.each(data, function (i, v) {
                        $('#tbody-outofstock').append('<tr>\
                                                <td>'+ i + '</td>\
                                                <td>'+ v.Brand + '</td>\
                                                <td>'+ v.Name + '</td>\
                                                <td>'+ v.Model + '</td>\
                                                <td>'+ v.ItemBarcode + '</td>\
                                                <td>'+ v.QtyByPc + '</td>\
                                                <td>'+ v.SellingPrice + '</td>\
                                            </tr>');
                    });

                    $('#badge-outofstocks').html(data.length);
                })
                .fail(function () {
                    console.log("Error retrieving out of stock items");
                });
        }
        // Refresh UNASSIGNED list
        function ReloadUnassigned() {
            $('#tbody-unassigned').html('<img src="/Icon/loading-spinner-34.gif" class="center-block" />');
            $.getJSON("/Product/GetUnassignedStocks")
                .done(function (data) {
                    $('#tbody-unassigned').html('');
                    $.each(data, function (i, v) {
                        $('#tbody-unassigned').append('<tr>\
                                                <td>'+ i + '</td>\
                                                <td>'+ v.Brand + '</td>\
                                                <td>'+ v.Name + '</td>\
                                                <td>'+ v.Model + '</td>\
                                                <td>'+ v.TotalItemStocks + '</td>\
                                                <td>'+ v.UnitPrice + '</td>\
                                                <td>'+ v.Srp + '</td>\
                                                <td>'+ v.SellingPrice + '</td>\
                                                <td>\
                                                    <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#modal-assign-values" data-sid="'+ v.Id + '">Set Price</button>\
                                                </td>\
                                            </tr>');
                    });

                    $('#badge-unassignedstocks').html(data.length);
                })
                .fail(function () {
                    console.log("Error retrieving unassigned items");
                });
        }

        // Stock-in (BARCODE SCAN)
        //$('#btn-stockin').on('click', function () {
        //    $('#modal-stockin').find('modal-body').append('<img src="/Icon/loading-spinner-34.gif" />');

        //    var prodId = parseInt($('#btn-stockin').data('pid'));
        //    var barcode = $('#txt-barcode').val();
        //    var qty = $('#txt-qty').val();

        //    $.getJSON("/Product/AddStock", { productId: prodId, qty: qty, barcode: barcode })
        //        .done(function (data) {
        //            if (data == true) {
        //                $(".modal").modal('hide');

        //                $('#modal-stockin').find('img').remove();
        //            }
        //        })
        //        .fail(function () {
        //            console.log("Error stock in");
        //        });
        //});
        $('#txt-barcode').on("keyup", function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                $('#modal-stockin').find('modal-body').append('<img src="/Icon/loading-spinner-34.gif" />');

                var prodId = parseInt($('#hid-prodid').data('pid'));
                var barcode = $('#txt-barcode').val();
                var qty = $('#txt-qty').val();

                console.log(prodId);

                $.getJSON("/Product/AddStock", { productId: prodId, qty: qty, barcode: barcode })
                    .done(function (data) {
                        if (data == true) {
                            $(".modal").modal('hide');

                            $('#modal-stockin').find('img').remove();
                        }
                    })
                    .fail(function () {
                        console.log("Error stock in");
                    });
            }
        });

        function LoadPriceList(itemId) {
            $.getJSON("/Product/GetItemStocks", { purchaseId: itemId })
                .done(function (data) {
                    $('#tbody-sellingprice').html('');
                    $.each(data, function (i, v) {
                        $('#tbl-sellingprice').find('tbody').append('<tr>\
                                                                        <td class= "size-60 text-center"> <div class="form-checkbox"><input type="checkbox" value="value1" name="name1"> <span class="check"><i class="fa fa-check"></i></span></div></td>\
                                                                        <td>'+ v.Brand +'</td>\
                                                                            <td><strong>'+ v.Name +'</strong></td>\
                                                                            <td>'+ v.UnitPrice +'</td>\
                                                                            <td>'+ v.SRP +'</td>\
                                                                            <td>'+ v.SellingPrice +'</td>\
                                                                            <td class="size-80 text-center">\
                                                                                <div class="dropdown">\
                                                                                    <a class="more-link" data-toggle="dropdown" href="#/"><i class="icon-dot-3 ellipsis-icon"></i></a>\
                                                                                    <ul class="dropdown-menu dropdown-menu-right">\
                                                                                        <li><a href="">Change Date Range</a></li>\
                                                                                        <li><a href="">Change Graph Type</a></li>\
                                                                                        <li><a href="">Other Settings</a> </li>\
                                                                                    </ul>\
                                                                                </div>\
                                                                            </td>\
                                                                    </tr>');
                    });
                })
                .fail(function () {
                    console.log("Error retrieving available stocks");
                });
        }

    </script>
}